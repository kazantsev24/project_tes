{
  "hash": "4b70a695515a033d66c9a66a095326e7",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Распознавание и разметка части книги Михаила Булгакова «Мастер и Маргарита»\"\n---\n\n\nВ качестве отсканированного текста возьмем книгу Михаила Булгаков [«Мастер и Маргарита»](https://www.bulgakov.ru/pdf/Master-i-Margarita.pdf), Москва 1984 г\n\n*Текст печатается в последней прижизненной редакции (рукописи хранятся в рукописном отделе Государственной библиотеки СССР имени В. И. Ленина), а также с исправлениями и дополнениями, сделанными под диктовку писателя его женой,\nЕ. С. Булгаковой.*\n\n1. Выделим 12 страниц из всей книги (с 9 по 20)\n2. Скачаем предобученную модель для русского языка\n3. С помощью пакета {tesseract} распознаем текст и сохраним его в файл mmrasp.txt\n\n4. Затем уберём (1) перенос слов, (2) строки с числами, (3) строки, состоящие из двух символов, первый из которых т или Т (это номера страниц) с помощью пакета {tidyverse}, результат положим в файл mmrasp_clean.txt\n\n5. Разметим текст согласно схеме TEI с помощью LLM, результат сохраним в test.xlm\n\n\n::: {.cell}\n\n```{.r .cell-code}\n  my_files <- list.files( pattern = \"pdf\", full.names = TRUE)\n  \n  mf <- my_files\n  #1\n  #pdf_subset(input = mf,\n  #          output = \"./mm921.pdf\",\n   #         pages = 9:20)\n  #2\n  #tesseract_download(\"rus\")\n  #tesseract_info()$available\n  #3\n  text3 <- pdf_ocr_text(\"./mm921.pdf\", \n                        language = \"rus\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nConverting page 1 to mm921_1.png... done!\nConverting page 2 to mm921_2.png... done!\nConverting page 3 to mm921_3.png... done!\nConverting page 4 to mm921_4.png... done!\nConverting page 5 to mm921_5.png... done!\nConverting page 6 to mm921_6.png... done!\nConverting page 7 to mm921_7.png... done!\nConverting page 8 to mm921_8.png... done!\nConverting page 9 to mm921_9.png... done!\nConverting page 10 to mm921_10.png... done!\nConverting page 11 to mm921_11.png... done!\nConverting page 12 to mm921_12.png... done!\n```\n\n\n:::\n\n```{.r .cell-code}\n  #4.1\n  writeLines(text3, con = \"./mmrasp.txt\")\n  text_clean <- text3 %>%\n  paste(collapse = \"\\n\") %>%\n  str_replace_all(\"-\\\\s*\\\\n\\\\s*\", \"\") %>%\n  str_split(\"\\n\") %>%\n  unlist() %>%\n  #4.2\n  discard(~ str_detect(.x, \"^\\\\d+$\")) %>%\n  #4.3\n  discard(~ str_detect(.x, \"^[Тт].$\")) %>%\n  str_trim() %>%\n  discard(~ .x == \"\")\n  writeLines(text_clean, con = \"./mmrasp_clean.txt\")\n#5\nSys.setenv(OPENROUTER_API_KEY = \"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\")\nsystem_prompt <- \"\nYou are an expert TEI encoder specializing in Russian literary texts.\n\nCRITICAL RULES:\n1. Preserve the original text EXACTLY — no spelling corrections, no normalization\n2. Maintain original punctuation, capitalization, and line breaks\n3. Do not modernize language\n4. Output ONLY valid TEI XML\n\nTAGGING GUIDELINES:\n- Wrap every paragraph in <p>\n- Tag personal names with <persName>\n- Tag dates and temporal expressions with <date>\n- Tag chapter titles with <head>\n- Tag geographic references with <place>\n  * Cities: <place type='city'>Москва</place>\n  * Streets and urban locations: <place type='street'>Садовая</place>\n  * Parks and squares: <place type='park'>Патриаршие пруды</place>\n  * Regions: <place type='region'>Сибирь</place>\n  * Use type='fictional' for imaginary places\n\nRETURN FORMAT:\nReturn only the text with added TEI tags, no additional commentary.\nDo not add explanations, comments, or metadata.\n\"\ninput_text <- paste(text_clean, collapse = \"\\n\")\n\nuser_prompt <- input_text\n\nchat <- chat_openrouter(\n  system_prompt = system_prompt,\n  api_key = Sys.getenv(\"OPENROUTER_API_KEY\"),\n  model = \"openai/gpt-oss-20b:free\", \n  echo = FALSE\n)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: The `api_key` argument of `chat_openrouter()` is deprecated as of ellmer 0.4.0.\nℹ Please use the `credentials` argument instead.\n```\n\n\n:::\n\n```{.r .cell-code}\nresult <- chat$chat(user_prompt)\nresult <- paste(\"<text>\\n\", result, \"\\n</text>\")\nwrite_lines(result, file = \"test.xml\")\n```\n:::\n\n6. Получился такой текст\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"<text>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 \n [2] \" <TEI>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 \n [3] \"  <text>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \n [4] \"    <body>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             \n [5] \"      <head>ГЛАВА 1</head>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             \n [6] \"      <p>… Так кто ж ты, наконеи?</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  \n [7] \"      <p>— Я - часть той силы,</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \n [8] \"      <p>чио вечно хочет</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           \n [9] \"      <p>зла и вечно совершает благо.</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              \n[10] \"      <p>Гете, «Фауст»</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             \n[11] \"      <p>Никогда не разговаривайте с неизвестными</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  \n[12] \"      <p>Однажды весною, в час небывало жаркого заката, в <place type='city'>Москва</place>,</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       \n[13] \"      <p>на <place type='park'>Патриаршие пруды</place>, появились два гражданина. Первый</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          \n[14] \"      <p>из них, одетый в летнюю серенькую пару, был маленького роста, упитан, лыс, свою приличную шляпу пирожком нес в руке,</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      \n[15] \"      <p>а на хорошо выбритом лице его помещались сверхъестественных размеров очки в черной роговой оправе. Второй - плечистый, рыжеватый, вихрастый молодой человек в заломленной</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                 \n[16] \"      <p>на затылок клетчатой кепке - был в ковбойке, жеваных белых</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                \n[17] \"      <p>брюках и в черных тапочках.</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \n[18] \"      <p>Первый был не кто иной, как <persName>Михаил Александрович</persName> <persName>Берлиоз</persName>, председатель правления одной из крупнейших московских литературных ассоциаций, сокращенно именуемой</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                   \n[19] \"      <p>МАССОЛИТ, и редактор толстого художественного журнала, а молодой спутник его - поэт <persName>Иван Николаевич</persName> <persName>Понырев</persName>, пишущий под псевдонимом Бездомный.</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                 \n[20] \"      <p>Попав в тень чуть зеленеющих лип, писатели первым долгом бросились к пестро раскрашенной будочке с надписью «Пиво и воды».</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                \n[21] \"      <p>Да, следует отметить первую странность этого страшного</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    \n[22] \"      <p>майского вечера. Не только у будочки, но и во всей аллее,</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 \n[23] \"      <p>параллельной Малой Бронной улице, не оказалось ни одного человека. В тот час, когда уж, кажется, и сил не было дышать,</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    \n[24] \"      <p>когда солнце, раскалив <place type='city'>Москва</place>, в сухом тумане валилось кудато за <place type='street'>Садовое кольцо</place>, - никто не пришел под липы, никто</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                \n[25] \"      <p>не сел на скамейку, пуста была аллея.</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \n[26] \"      <p>— Дайте нарзану, — попросил <persName>Берлиоз</persName>.</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 \n[27] \"      <p>— Нарзану нету, — ответила женщина в будочке и почемуто обиделась.</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \n[28] \"      <p>— Пиво есть? —- сиплым голосом осведомился Бездомный.</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \n[29] \"      <p>— Пиво привезут к вечеру, — ответила женщина.</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             \n[30] \"      <p>— А что есть? — спросил <persName>Берлиоз</persName>.</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \n[31] \"      <p>— Абрикосовая, только теплая, — сказала женщина.</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          \n[32] \"      <p>— Ну, давайте, давайте, давайте!..</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \n[33] \"      <p>Абрикосовая дала обильную желтую пену, и в воздухе запахло парикмахерской. Напившись, литераторы немедленно начали икать, расплатились и уселись на скамейке лицом к пруду и спиной к Бронной.</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                            \n[34] \"      <p>Тут приключилась вторая странность, касающаяся одного <persName>Берлиоза</persName>. Он внезапно перестал икать, сердце его стукнуло и на мгновенье куда-то провалилось, потом вернулось, но ступой иглой, засевшей в нем. Кроме того, Берлиоза охватил необоснованный, но столь сильный страх, что ему захотелось тотчас же бежать с <place type='park'>Патриарших</place> без оглядки. Берлиоз тоскливо оглянулся, не понимая, что его напугало. Он побледнел, вытер лоб платком, подумал: «Что это со мной? Этого никогда не было... сердце шалит... я переутомился. Пожалуй, пора бросить все к черту и в Кисловодск…»</p>\"\n[35] \"      <p>И тут знойный воздух сгустился перед ним, и соткался из этого воздуха прозрачный гражданин престранного вида.</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             \n[36] \"      <!-- The following paragraphs continue in the same pattern, preserving the original text. -->\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    \n[37] \"      <!-- Personal names such as Михайла Александровича Берлиоза, Иван Николаевич Понырев, Филипа Александрийского, Иосифа Флавия, etc., should be wrapped in <persName>. -->\"                                                                                                                                                                                                                                                                                                                                                                                                                                                         \n[38] \"      <!-- Places such as <place type='city'>Москва</place>, <place type='park'>Патриаршие пруды</place>, <place type='street'>Садовое кольцо</place>, <place type='city'>Кисловодск</place> should be marked similarly. -->\"                                                                                                                                                                                                                                                                                                                                                                                                           \n[39] \"      <p>— Фу ты черт! — воскликнул редактор, — ты знаешь, Иван, у меня сейчас едва удар от жары не сделался! Даже что-то вроде галлюцинации было, — он попытался усмехнуться, но в глазах его еще прыгала тревога, и руки дрожали.</p>\"                                                                                                                                                                                                                                                                                                                                                                                                \n[40] \"      <p>Однако постепенно он успокоился, обмахнулся платком и, произнеся довольно бодро: «Ну-с, итак...» — повел речь, прерванную питьем абрикосовой.</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                             \n[41] \"      <p>Речь эта, как впоследствии узнали, шла об Иисусе Христе.</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  \n[42] \"      <p>Дело в том, что редактор заказал поэту для очередной книжки журнала большую антирелигиозную поэму. Эту поэму <persName>Иван Николаевич</persName> сочинил, и в очень короткий срок, но, к сожалению, ею редактора нисколько не удовлетворил.</p>\"                                                                                                                                                                                                                                                                                                                                                                              \n[43] \"      <p>Очертил Бездомный главное действующее лицо своей поэмы, то есть Иисуса, очень черными красками, и тем не менее всю поэму приходилось, по мнению редактора, писать заново. И вот теперь редактор читал поэту нечто вроде лекции об Иисусе, с тем чтобы подчеркнуть основную ошибку поэта.</p>\"                                                                                                                                                                                                                                                                                                                                  \n[44] \"      <p>Трудно сказать, что именно подвело Иван Николаевича — изобразительная ли сила его таланта или полное незнакомство с вопросом, по которому он собирался писать, - но Иисус в его изображении получился ну совершенно как живой, хотя и не привлекающий к себе персонаж.</p>\"                                                                                                                                                                                                                                                                                                                                                    \n[45] \"      <!-- More content continues following the same structure... -->\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  \n[46] \"      <p>— А вы соглашались с вашим собеседником? — осведомился неизвестный, повернувшись вправо к Бездомному.</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \n[47] \"      <p>— На все сто! — подтвердил тот, любя выражаться вычурно и фигурально.</p>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \n[48] \"      <p>— Изумительно! — воскликнул непрошеный собеседник и, почему-то воровски оглянувшись и приглушив свой низкий голос, сказал: — Простите мою навязчивость, но я так понял, что вы, помимо всего прочего, еще и не верите в бога? — он сделал испуганные глаза и прибавил: — Клянусь, я никому не скажу.</p>\"                                                                                                                                                                                                                                                                                                                      \n[49] \"      <!-- The rest of the story continues verbatim. -->\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \n[50] \"    </body>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \n[51] \"  </text>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              \n[52] \"</TEI> \"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                \n[53] \"</text>\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                \n```\n\n\n:::\n:::\n\n7. Выведем статистику по нашему xml-документу:\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\nКоличество абзацев: 39 \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nКоличество упоминаний персонажей: 8 \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nСписок персонажей: Михаил Александрович Берлиоз Иван Николаевич Понырев Берлиоз Берлиоз Берлиоза Иван Николаевич \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nКоличество упоминаний мест: 5 \n```\n\n\n:::\n:::\n\n8. А теперь выводим график частоты упоминания персонажей\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}